# Vigilante Malware Cleaner

*2018-05-22*

PHP downloaded to WSO web shell's "RC" action for immediate eval
that finds 56 different indications of PHP malware,
counts those indications,
returning the counts to the invoker.
It renames any file containing an indication of PHP malware.

Because it renames the files it finds malware indications in,
I imagine the authors/invokers consider themselves good guys:
they can find out what malware is installed,
and they can effectively neutralize that malware.

I found an [older capture](198.71.239.32-2018-02-26a)
after I finished this analysis.
See that directory for analysis of any changes in the last 3 months.

It's possible that this code has been around and in use for a long time.

* [2015-12-11 possible Joomla instance](https://forum.joomla.org/viewtopic.php?t=902352)
* [2016-07-08 possible cPanel instance](https://forums.cpanel.net/threads/suspected-file.555341/)
* [2015-12-15 possible Joomla instacne](https://stackoverflow.com/questions/31725357/php-file-changes-its-extension-to-suspeced)
* [2015-06-10 note](http://www.dbafire.com/2015/06/10/wp-includeslink-template-php-wordpress-problem-link-template-php-suspected/)

Looks like this Vigilante AV effort started June of 2015 or so.

The 2015-12-15 report has code that one of the matching functions would flag exactly.

2018-11-14: my WSO honey pot caught [another version](192.185.4.121-2018-11-14a).

2018-11-20: my WSO honey pot caught [another one](108.179.194.80-2018-11-21a)

2018-11-21: my WSO honey pot caught [another one](94.46.15.160-2018-11-22a)

2018-11-22: my WSO honey pot caught [another one](91.236.153.247-2018-11-23a)

2019-02-09: my WSO honey pot caught [another one](120.79.20.249-2019-03-04a)

There is ongoing development relating to which strings indicate compromised files.

## Origin

### IP Address 198.72.239.41

198.72.239.41 has DNS name a2nlwpweb040.prod.iad2.secureserver.net

It's owned by GoDaddy.

a2nlwpweb040.prod.iad2.secureserver.net has IP address 198.71.239.41 in DNS.

secureserver.net is owned by GoDaddy.

### Download

Looks like the attacker thought they were sending code to a WSO web shell.
They wanted to use WSO's "RC" action, which immediately eval's
any PHP code that arrives in the 'p1' HTTP POST parameter.

They thought that WSO was at `/wp-content/themes/sketch/404.php`.
That's a pretty common place for someone to hide WSO.
People download the "sketch" theme to my WordPress honey pot frequently.

## Analysis

The downloaded code consists of an unencoded portion,
a base64-encoded set of function definitions,
and a serialized, base64-encoded array-of-arrays.

### Unencoded portion

This looks a lot like boilerplate code for a program
dropper that's used to install a variety of PHP malware.
The [Code-in-cookie back door](backdoors/212.54.205.145-2018-01-25a)
has an almost exact copy of the `GetDocRoot()` function,
and the back door's `GetDirectoryList()` is clearly the
ancestor of this code's `GetFileList()` function.

Between functions `GetDocRoot()` and `GetFileList()`,
the code produces a list of files,
probably all files under Apache's DocumentRoot directory.
Circumstances exist where some subdirectory of Apache's
DocumentRoot or even "/"
(the root of the filesystem) might be used.

### Set of function definitions

The code creates 112 oddly-named functions
via the old favorite `eval(base64_decode())` function
composition.
Half (56) of the functions have an argument named `$path`,
the other half have an argument named `$content`.
The 56 functions with an argument named `$path` 
are identical except for the function name.
As an example:

    function gzfkylyosi($path)
    {
        if (!@rename($path, $path . ".suspected")) {
            @unlink($path);
        }
    }

All these 56 functions either rename a file to have
".suspected" as a suffix,
or they delete the file.

The other 56 functions,
all having one formal argument named `$content`,
check for the presence of various strings.
These functions vary in complexity,
but a typical function looks like this:

    function rzbvtgkg($content)
    {
        if (strpos($content, "b374k 2.8") !== FALSE) {
            return TRUE;
        }
        return FALSE;
    }

It appears that each of the 56 `$content` functions
looks for a string or strings that appear in a particular PHP malware.
The above function clearly returns TRUE if it finds a
[b374k](webshells/b374k) web shell.

### Serialized array-of-arrays

Once base64-decoded and unserialized,
the array-of-arrays named `$defs` contains entries like this:

    {15, "rtob", "gfjsi"}

There are 56 of these entries.
Each string in the entry matches the name of a function.
For the entry above:

    function rtob($content)
    {
        if (strpos($content, "if(mail(\$MailTo,") !== FALSE) {
            if (substr_count($content, ")") == 14) {
                return TRUE;
            }
        }
        return FALSE;
    }
    function gfjsi($path)
    {
        if (!@rename($path, $path . ".suspected")) {
            @unlink($path);
        }
    }

One function to identify a file that might or probably
contains PHP malware code,
and one function to rename the file to "file.suspected".

Interestingly, the 0-element of the entries are not
numbered consecutively, running from 2 to 198.
Did more signatures appear in previous 
versions of this code in the past?

The three parts of this malware look
for "signatures" of other PHP malware,
then renames the files found.
It counts the number of each signature it finds,
and prints out a base64-encoded serialization of the array of counts of signatures.
That's clearly a machine-readable summary of what it found.

## Some malware that it will rename if found

* WSO 2.5, 2.5.1, 2.8, 3.1 web shells
* Most other WSO web shell variants
* [b374k web shell](webshells/b374k), but only v2.8
* Anything FOPO-encoded
* [nptzow](../nptzow)
* Itself, but it's careful to not count itself twice
* JavaScript from "Ayildiz Tim" Turkish hackers' HTML
* Anything with the string '<?php @eval($_POST[', which should catch a lot of the 1-liner backdoors in WordPress themes or plugins
* Anything with the string `eval(gzinflate(base64_decode(`, which catches a lot of droppers
* Anything with a URL that [Spam Blocklist Recon malware](../36.65.41.151-2018-05-04a) often uses
* 45 others that I don't recognize

## ".suspected" URLs accessed

I have Apache `access_log` files in "combined" format dating back to 2009.
It looks like URIs with a ".suspected" suffix have shown up in the past,
the earliest from 2016

    2016-04-12 03:51:10-06 | 178.151.184.223 | /wp-content/plugins/wp-arm-config/antibot.php.suspected

Bizarrely, some URLs I found in my logs have a ".suspected_" suffix, perhaps another layer of moving the code around.

I don't understand accessing those URLs,
as Apache/2.4.33 seems to just send any such file's contents,
but without a "Content-type:" header.
Apache doesn't run the PHP interpreter on the URL's contents, so what's the point?

## Ongoing Development

As of 2018-11-24, my honey pot has received 6 downloads.
Because the search and cleanup function names consist
of random series of characters,
a little further analysis seems in order.

Each downloaded file has an array named `$defs`,
deserialized from a base64-encoded string.
Each element of array `$defs` consists of a triplet:
`[serial number, search function name, cleanup function name]`

There are 32 serial numbers common to all 4 different defs files.
The function names change (all begin with an 'r'),
but the bodies of the functions remain the same for all 32 common
serial numbers, across all downloads.

It seems like the vigilantes keep track of the search functions,
and potentially cleanup functions,
by a number, which I've called "serial number".

### Changing Search Functions

|Arrival Date|Count of functions|Count of Changed Functions|
|-----------|------------------|----|
|2018-02-27 | 88 |
|2018-05-19 | 56 | -34, +2
|2018-11-14 | 59 | -22, +25
|2018-11-20 | 60 | +1
|2018-11-22 | 60 | 0 |
|2018-11-23 | 60 | 0 |
|2019-02-09 | 67 | -8, +15|

The last 3 downloads are identical except for randomized 
function names.

It seems obvious that the vigilante development team
makes changes in the functions that this software uses
to detect malware.
They might base their changes on the serialized count
of functions found, ordered by serial number.
When a given serial number's function doesn't find other's
malware in a while,
they could remove that function.
It's a little harder to see a way for them to decide to
add a function, without some blind experimentation,
or somehow getting WordPress malware samples.

The search functions find WSO instances in
at least 2 different ways,
so the vigilantes are set on finding and eliminating
WSO instances.
Barring a mistake, the vigilante software renames the WSO shell
used to perform their cleanup,
rendering it inoperable.

Therefore, the vigilance committee must repeatedly
obtain URLs and passwords for WSO instances in some fashion.
It's possible that they purchase WSO access,
but if they destroy some or all of the WSO instances in
any given list, why would any purveyor of such information
sell to them more than once?
